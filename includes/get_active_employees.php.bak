<?php
// Start session if not already started
if (sess    $employees = [];

    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        // Format the data
        $employees[] = [
            'pagibig_number' => $row['pagibig_number'],
            'id_number' => $row['id_number'],
            'last_name' => $row['last_name'],
            'first_name' => $row['first_name'],
            'middle_name' => $row['middle_name'],
            'tin' => $row['tin'],
            'birthdate' => $row['birthdate'],
            'ee' => $row['ee'] ?? 200.00,
            'er' => $row['er'] ?? 200.00,
            'status' => $row['status']
        ];
    }HP_SESSION_NONE) {
    session_start();
}

// Clean any existing output and start fresh
while (ob_get_level()) {
    ob_end_clean();
}

require_once 'db_connect.php';

// Set headers
header('Content-Type: application/json');
header('Cache-Control: no-cache, must-revalidate');

// Check authentication
if (!isset($_SESSION['user_id'])) {
    echo json_encode([
        'success' => false,
        'message' => 'Authentication required',
        'code' => 'AUTH_REQUIRED'
    ]);
    exit;
}

try {
    global $conn;
    if (!$conn) {
        throw new Exception('Database connection failed');
    }

    // Fetch active employees with their contributions
    $sql = "SELECT 
        e.*,
        sc.ee,
        sc.er
    FROM 
        employees e
        LEFT JOIN selected_contributions sc ON e.pagibig_number = sc.pagibig_no 
            AND sc.user_id = :user_id
    WHERE 
        e.status = 'ACTIVE'
    ORDER BY 
        e.last_name, e.first_name";

    $stmt = $conn->prepare($sql);
    if (!$stmt) {
        throw new Exception('Failed to prepare statement');
    }

    $stmt->bindValue(':user_id', $_SESSION['user_id'], PDO::PARAM_INT);
    
    if (!$stmt->execute()) {
        throw new Exception('Failed to execute query');
    }
    $employees = [];

    while ($row = $result->fetch_assoc()) {
        // Format the data
        $employees[] = [
            'pagibig_number' => $row['pagibig_number'],
            'id_number' => $row['id_number'],
            'last_name' => $row['last_name'],
            'first_name' => $row['first_name'],
            'middle_name' => $row['middle_name'],
            'tin' => $row['tin'],
            'birthdate' => $row['birthdate'],
            'ee' => $row['ee'] ?? 200.00,
            'er' => $row['er'] ?? 200.00,
            'status' => $row['status']
        ];
    }

    echo json_encode([
        'success' => true,
        'data' => $employees,
        'count' => count($employees)
    ]);

} catch (Exception $e) {
    error_log('Error in get_active_employees.php: ' . $e->getMessage());
    http_response_code(500);
    echo json_encode([
        'success' => false,
        'message' => $e->getMessage(),
        'code' => 'DB_ERROR'
    ]);
}

// Clean output buffer and send response
ob_end_clean();
exit();
?>
